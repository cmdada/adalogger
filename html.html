<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>adalogger</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #333;
      color: #fff;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { 
      font-size: 2em; 
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .subtitle { 
      opacity: 0.9; 
      margin-bottom: 30px;
      font-size: 1.1em;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .stat-value { font-size: 2em; font-weight: bold; margin-top: 5px; }
    .stat-label { opacity: 0.8; font-size: 0.9em; }
    .section {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .section h2 { margin-bottom: 20px; font-size: 1.5em; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    th {
      background: rgba(0,0,0,0.3);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }
    tr:hover { background: rgba(255,255,255,0.05); }
    .device-id { 
      font-family: 'Courier New', monospace; 
      font-weight: bold;
      font-size: 1.1em;
    }
    .btn {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      margin: 5px;
      transition: all 0.3s;
    }
    .btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    .error { color: #ff6b6b; font-weight: bold; }
    .active { color: #51cf66; }
    .inactive { color: #ffd43b; opacity: 0.7; }
    @media (max-width: 768px) {
      body { padding: 10px; }
      h1 { font-size: 1.5em; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      table { font-size: 0.85em; }
      th, td { padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>adalogger</h1>
    <p class="subtitle">2036 is fancy now</p>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Messages</div>
        <div class="stat-value" id="totalMsg">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Devices</div>
        <div class="stat-value" id="deviceCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Known Bus Errors</div>
        <div class="stat-value error" id="busErrors">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Uptime</div>
        <div class="stat-value" id="uptime">0s</div>
      </div>
    </div>
    
    <div class="section">
      <h2>Connected Devices</h2>
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th>CAN ID</th>
              <th>Device Type</th>
              <th>Manufacturer</th>
              <th>Device #</th>
              <th>Messages</th>
              <th>Last Seen</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="devicesTable">
            <tr><td colspan="7" style="text-align: center; opacity: 0.5;">No devices detected yet...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="section">
      <h2>Detected Errors</h2>
      <table>
        <tr><td>Bus Off Errors</td><td id="busOffErr">0</td></tr>
        <tr><td>Arbitration Lost</td><td id="arbLostErr">0</td></tr>
        <tr><td>RX Queue Full</td><td id="rxQueueErr">0</td></tr>
        <tr><td>TX Queue Full</td><td id="txQueueErr">0</td></tr>
      </table>
    </div>
    
    <div style="text-align: center;">
      <button class="btn" onclick="downloadLogs()">Download Logs (CSV)</button>
      <button class="btn" onclick="clearLogs()">üóëÔ∏èlear Logs</button>
      <button class="btn" onclick="location.reload()">Refresh</button>
    </div>
  </div>
  
  <script>
    function updateData() {
      fetch('/api/status')
        .then(r => r.json())
        .then(data => {
          document.getElementById('totalMsg').textContent = data.totalMessages.toLocaleString();
          document.getElementById('deviceCount').textContent = data.deviceCount;
          document.getElementById('busErrors').textContent = data.totalErrors;
          document.getElementById('uptime').textContent = formatUptime(data.uptimeMs);
          document.getElementById('busOffErr').textContent = data.busOffErrors;
          document.getElementById('arbLostErr').textContent = data.arbLostErrors;
          document.getElementById('rxQueueErr').textContent = data.rxQueueFull;
          document.getElementById('txQueueErr').textContent = data.txQueueFull;
        });
      
      fetch('/api/devices')
        .then(r => r.json())
        .then(data => {
          const tbody = document.getElementById('devicesTable');
          if (data.devices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; opacity: 0.5;">No devices detected yet...</td></tr>';
            return;
          }
          
          tbody.innerHTML = data.devices.map(dev => {
            const age = Date.now() - dev.lastSeenMs;
            const status = age < 2000 ? '<span class="active">‚óè</span> Active' : 
                          age < 10000 ? '<span class="inactive">‚óè</span> Recent' : 
                          '<span style="color:#868e96">‚óè</span> Idle';
            return `
              <tr>
                <td class="device-id">0x${dev.canId.toString(16).toUpperCase().padStart(3, '0')}</td>
                <td>${dev.deviceType}</td>
                <td>${dev.manufacturer}</td>
                <td>${dev.deviceNumber}</td>
                <td>${dev.messageCount.toLocaleString()}</td>
                <td>${formatTime(age)}</td>
                <td>${status}</td>
              </tr>
            `;
          }).join('');
        });
    }
    
    function formatUptime(ms) {
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      if (h > 0) return h + 'h ' + (m % 60) + 'm';
      if (m > 0) return m + 'm ' + (s % 60) + 's';
      return s + 's';
    }
    
    function formatTime(ms) {
      if (ms < 1000) return 'just now';
      const s = Math.floor(ms / 1000);
      if (s < 60) return s + 's ago';
      const m = Math.floor(s / 60);
      if (m < 60) return m + 'm ago';
      return Math.floor(m / 60) + 'h ago';
    }
    
    function downloadLogs() {
      window.location.href = '/api/logs/download';
    }
    
    function clearLogs() {
      if (confirm('Clear all stored logs?')) {
        fetch('/api/logs/clear', {method: 'POST'})
          .then(() => alert('Logs cleared!'));
      }
    }
    
    updateData();
    setInterval(updateData, 1000);
  </script>
</body>
</html>
