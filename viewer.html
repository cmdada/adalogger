<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>adalogger log viewer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #333;
      color: #fff;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { 
      font-size: 2.5em; 
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .subtitle { 
      opacity: 0.9; 
      margin-bottom: 30px;
      font-size: 1.1em;
    }
    .upload-section {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px dashed rgba(255,255,255,0.3);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .upload-section:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
    }
    .upload-section.dragging {
      background: rgba(255,255,255,0.25);
      border-color: #fff;
    }
    input[type="file"] { display: none; }
    .upload-btn {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 15px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.3s;
      display: inline-block;
    }
    .upload-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .stat-value { font-size: 2em; font-weight: bold; margin-top: 5px; }
    .stat-label { opacity: 0.8; font-size: 0.9em; }
    .section {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .section h2 { margin-bottom: 20px; font-size: 1.5em; }
    .chart-container {
      position: relative;
      height: 400px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 0.9em;
    }
    th {
      background: rgba(0,0,0,0.3);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8em;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tr:hover { background: rgba(255,255,255,0.05); }
    .table-wrapper {
      max-height: 500px;
      overflow-y: auto;
      border-radius: 8px;
    }
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .filter-bar input, .filter-bar select {
      background: rgba(0,0,0,0.3);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 10px 15px;
      border-radius: 6px;
      font-size: 0.95em;
    }
    .filter-bar input::placeholder { color: rgba(255,255,255,0.5); }
    .error-badge {
      background: #ff6b6b;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: bold;
    }
    .hex-data {
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
      opacity: 0.9;
    }
    .hidden { display: none; }
    .btn {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      margin: 5px;
      transition: all 0.3s;
    }
    .btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    @media (max-width: 768px) {
      h1 { font-size: 1.8em; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .chart-container { height: 300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>adalogger log viewer</h1>
    <p class="subtitle">upload and view</p>
    
    <div class="upload-section" id="uploadZone">
      <div style="font-size: 3em; margin-bottom: 15px;">üìÅ</div>
      <p style="font-size: 1.2em; margin-bottom: 10px;">Drop your CSV log file here</p>
      <p style="opacity: 0.7; margin-bottom: 20px;">or</p>
      <label for="fileInput" class="upload-btn">Choose File</label>
      <input type="file" id="fileInput" accept=".csv">
      <p style="opacity: 0.6; margin-top: 15px; font-size: 0.9em;">Supports CSV files from adalogger</p>
    </div>
    
    <div id="dataView" class="hidden">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Messages</div>
          <div class="stat-value" id="totalMsgs">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Unique Devices</div>
          <div class="stat-value" id="uniqueDevices">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Error Messages</div>
          <div class="stat-value" id="errorCount" style="color: #ff6b6b;">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Time Span</div>
          <div class="stat-value" id="timeSpan">0s</div>
        </div>
      </div>
      
      <div class="section">
        <h2>üìä Message Traffic Over Time</h2>
        <div class="chart-container">
          <canvas id="trafficChart"></canvas>
        </div>
      </div>
      
      <div class="section">
        <h2>üéØ Messages by Device</h2>
        <div class="chart-container">
          <canvas id="deviceChart"></canvas>
        </div>
      </div>
      
      <div class="section">
        <h2>üìã Message Log</h2>
        <div class="filter-bar">
          <input type="text" id="filterCANID" placeholder="Filter by CAN ID...">
          <select id="filterError">
            <option value="all">All Messages</option>
            <option value="errors">Errors Only</option>
            <option value="normal">Normal Only</option>
          </select>
          <button class="btn" onclick="exportFiltered()">Export Filtered</button>
          <button class="btn" onclick="clearData()">Clear Data</button>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>CAN ID</th>
                <th>Ext</th>
                <th>RTR</th>
                <th>DLC</th>
                <th>Data</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="logTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let logData = [];
    let trafficChart = null;
    let deviceChart = null;
    
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const dataView = document.getElementById('dataView');
    
    // Drag and drop handlers
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragging');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragging');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragging');
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.csv')) {
        processFile(file);
      } else {
        alert('Please upload a CSV file');
      }
    });
    
    uploadZone.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) processFile(file);
    });
    
    function processFile(file) {
      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results) => {
          logData = results.data;
          analyzeData();
          displayData();
          dataView.classList.remove('hidden');
        },
        error: (error) => {
          alert('Error parsing CSV: ' + error.message);
        }
      });
    }
    
    function analyzeData() {
      const totalMsgs = logData.length;
      const uniqueDevices = new Set(logData.map(row => row.CAN_ID)).size;
      const errorCount = logData.filter(row => row.Error === 1 || row.Error === '1').length;
      
      const timestamps = logData.map(row => row.Timestamp).filter(t => t);
      const timeSpan = timestamps.length > 0 ? 
        Math.max(...timestamps) - Math.min(...timestamps) : 0;
      
      document.getElementById('totalMsgs').textContent = totalMsgs.toLocaleString();
      document.getElementById('uniqueDevices').textContent = uniqueDevices;
      document.getElementById('errorCount').textContent = errorCount;
      document.getElementById('timeSpan').textContent = formatDuration(timeSpan);
    }
    
    function displayData() {
      createTrafficChart();
      createDeviceChart();
      updateLogTable();
    }
    
    function createTrafficChart() {
      const ctx = document.getElementById('trafficChart').getContext('2d');
      
      // Group messages by time buckets (1 second intervals)
      const timeBuckets = {};
      logData.forEach(row => {
        const bucket = Math.floor(row.Timestamp / 1000);
        timeBuckets[bucket] = (timeBuckets[bucket] || 0) + 1;
      });
      
      const labels = Object.keys(timeBuckets).sort((a, b) => a - b);
      const data = labels.map(label => timeBuckets[label]);
      
      if (trafficChart) trafficChart.destroy();
      
      trafficChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.map(l => formatTime(l * 1000)),
          datasets: [{
            label: 'Messages per Second',
            data: data,
            borderColor: 'rgba(81, 207, 102, 1)',
            backgroundColor: 'rgba(81, 207, 102, 0.2)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              labels: { color: '#fff' }
            }
          },
          scales: {
            x: { 
              ticks: { color: '#fff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: { 
              ticks: { color: '#fff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
    }
    
    function createDeviceChart() {
      const ctx = document.getElementById('deviceChart').getContext('2d');
      
      // Count messages per device
      const deviceCounts = {};
      logData.forEach(row => {
        const id = row.CAN_ID;
        deviceCounts[id] = (deviceCounts[id] || 0) + 1;
      });
      
      // Sort and take top 10
      const sorted = Object.entries(deviceCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      if (deviceChart) deviceChart.destroy();
      
      deviceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sorted.map(([id]) => id),
          datasets: [{
            label: 'Message Count',
            data: sorted.map(([, count]) => count),
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              labels: { color: '#fff' }
            }
          },
          scales: {
            x: { 
              ticks: { color: '#fff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: { 
              ticks: { color: '#fff' },
              grid: { color: 'rgba(255,255,255,0.1)' }
            }
          }
        }
      });
    }
    
    function updateLogTable() {
      const filterCANID = document.getElementById('filterCANID').value.toLowerCase();
      const filterError = document.getElementById('filterError').value;
      
      let filtered = logData;
      
      if (filterCANID) {
        filtered = filtered.filter(row => 
          row.CAN_ID && row.CAN_ID.toLowerCase().includes(filterCANID)
        );
      }
      
      if (filterError === 'errors') {
        filtered = filtered.filter(row => row.Error === 1 || row.Error === '1');
      } else if (filterError === 'normal') {
        filtered = filtered.filter(row => row.Error === 0 || row.Error === '0');
      }
      
      const tbody = document.getElementById('logTable');
      tbody.innerHTML = filtered.slice(0, 1000).map(row => {
        const isError = row.Error === 1 || row.Error === '1';
        return `
          <tr>
            <td>${formatTime(row.Timestamp)}</td>
            <td><strong>${row.CAN_ID || 'N/A'}</strong></td>
            <td>${row.Extended || '0'}</td>
            <td>${row.RTR || '0'}</td>
            <td>${row.DLC || '0'}</td>
            <td class="hex-data">${row.Data || ''}</td>
            <td>${isError ? `<span class="error-badge">${row.ErrorMsg || 'ERROR'}</span>` : '‚úì'}</td>
          </tr>
        `;
      }).join('');
      
      if (filtered.length > 1000) {
        tbody.innerHTML += `<tr><td colspan="7" style="text-align: center; opacity: 0.7;">Showing first 1000 of ${filtered.length} messages</td></tr>`;
      }
    }
    
    function formatTime(ms) {
      const date = new Date(ms);
      return date.toLocaleTimeString() + '.' + (ms % 1000).toString().padStart(3, '0');
    }
    
    function formatDuration(ms) {
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      if (h > 0) return `${h}h ${m % 60}m`;
      if (m > 0) return `${m}m ${s % 60}s`;
      return `${s}s`;
    }
    
    function exportFiltered() {
      const filterCANID = document.getElementById('filterCANID').value.toLowerCase();
      const filterError = document.getElementById('filterError').value;
      
      let filtered = logData;
      
      if (filterCANID) {
        filtered = filtered.filter(row => 
          row.CAN_ID && row.CAN_ID.toLowerCase().includes(filterCANID)
        );
      }
      
      if (filterError === 'errors') {
        filtered = filtered.filter(row => row.Error === 1 || row.Error === '1');
      } else if (filterError === 'normal') {
        filtered = filtered.filter(row => row.Error === 0 || row.Error === '0');
      }
      
      const csv = Papa.unparse(filtered);
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'filtered_can_log.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function clearData() {
      if (confirm('Clear all loaded data?')) {
        logData = [];
        dataView.classList.add('hidden');
        fileInput.value = '';
        if (trafficChart) trafficChart.destroy();
        if (deviceChart) deviceChart.destroy();
      }
    }
    
    // Add filter event listeners
    document.getElementById('filterCANID').addEventListener('input', updateLogTable);
    document.getElementById('filterError').addEventListener('change', updateLogTable);
  </script>
</body>
</html>
